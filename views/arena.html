<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Начальный экран выбора карт -->
    <div class="card-selection-screen" id="cardSelectionScreen">
        <div class="screen-header">
            <div class="timer" id="timer">00:30</div>
            <div class="choose-hero">Choose Your Hero</div>
        </div>
        <div class="card-options">
            <div class="card-option" data-card="card1">Card 1</div>
            <div class="card-option" data-card="card2">Card 2</div>
            <div class="card-option" data-card="card3">Card 3</div>
        </div>
        <button class="random-button" id="randomButton">Random</button>
    </div>

    <!-- Фон арены -->
    <img class="arena" src="arena.png" alt="collesium">
    <div id="loading">
        <p>Searching for other player</p>
        <br>
        <div class="loader"></div>
    </div>
    <div class="all">
        <!-- Кнопка для открытия/закрытия панели -->
        <div class="toggle-panel" id="togglePanel">
            <div class="toggle-arrow">></div>
        </div>

        <!-- Выезжающая панель -->
        <div class="side-panel" id="sidePanel">
            <button class="surrender-button">Сдаться</button>
        </div>

        <div class="opponent-avatar-block">
            <div class="avatar opponent-avatar"></div>
            <div class="enemy-nickname" id="opNick">Opponent Nick</div> <!-- Ник противника -->
        </div>

        <!-- Блок для счёта раундов и таймера -->
        <div class="round-timer">
            <!-- Круглый счётчик раундов -->
            <button class="button">Ready</button>
            <div class="round-display">Round: 1</div>

            <!-- Таймер под счётом раундов -->
            <div class="timer-display">00:30</div>
        </div>

        <!-- Блок для аватара и ника игрока -->
        <div class="player-avatar-block">
            <div class="avatar player-avatar"></div>
            <div class="nickname" id="playerNick">Player Nick</div> <!-- Ник игрока -->
        </div>

        <!-- Блок для карты противника сверху -->
        <div class="opponent-card">
            <div class="opponentcard-large">Opponent Card</div>
        </div>

        <!-- Блок для карт сверху -->
        <div class="top-cards">
            <div class="enemycard card-left">Card left</div>
            <div class="enemycard card-center">Card Center</div>
            <div class="enemycard card-right">Card Right</div>
        </div>

        <!-- Блок для карты на поле -->
        <div class="field-card">
            <div class="card-large">Field Card</div>
        </div>

        <!-- Блок для карт снизу -->
        <div class="bottom-cards">
            <div class="card">Card 4</div>
            <div class="card">Card 5</div>
            <div class="card">Card 6</div>
        </div>

        <div class="button-block">
            <button class="button">Action 1</button>
            <button class="button">Action 2</button>
            <div class="gold-display">Gold: 1000</div>
        </div>

        <!-- Вертикальный блок справа -->
        <div class="side-rect">
            <p>Side Block</p>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:3000');
        const arena = document.querySelector('.all');  // Инициализация сокета
        const load = document.querySelector('#loading');  // Инициализация сокета
        const cardOptions = document.querySelectorAll('.card-option');
        const cardSelectionScreen = document.getElementById('cardSelectionScreen');
        let heroCards = null;
        let timerInterval = null;

        const randomButton = document.getElementById('randomButton');
        const timerElement = document.getElementById('timer');

        let room_Id = null;
        let timeLeft = 30;  // Время в секундах
        let hasSelectedCard = false;  // Отслеживает, выбрал ли игрок карту

        // Функция для обновления таймера
        function updateTimer() {
            if (timeLeft > 0) {
                timeLeft--;
                const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                const seconds = String(timeLeft % 60).padStart(2, '0');
                timerElement.textContent = `${minutes}:${seconds}`;
            } else {
                clearInterval(timerInterval);
                if (!hasSelectedCard) {
                    selectRandomCard();
                }
            }
        }

        // Функция для выбора случайной карты
        function selectRandomCard() {
            const randomIndex = Math.floor(Math.random() * cardOptions.length);
            const randomCard = cardOptions[randomIndex];
            randomCard.click();  // Симуляция клика на случайную карту
        }

        // Добавляем обработчик на кнопку Random
        randomButton.addEventListener('click', function () {
            selectRandomCard();
        });

        // Обработчик клика на карты
        cardOptions.forEach(option => {
            option.addEventListener('click', function () {
                if (hasSelectedCard) return;  // Предотвращаем повторный выбор
                hasSelectedCard = true;  // Отмечаем, что карта выбрана

                const selectedCard = option.getAttribute('data-card');
                hideUnselectedCards(option);

                // Отправляем выбранную карту на сервер
                socket.emit('cardSelected', room_Id, {
                    playerId: localStorage.getItem('userId'),
                    card: selectedCard
                });

                // Останавливаем таймер
                clearInterval(timerInterval);
            });
        });

        function hideUnselectedCards(selectedOption) {
            cardOptions.forEach(option => {
                if (option !== selectedOption) {
                    option.style.visibility = 'hidden';  // Скрываем остальные карты
                }
            });
        }


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Отправляем информацию о себе
        socket.emit('userEmail', localStorage.getItem('userEmail'));
        socket.emit('userId', localStorage.getItem('userId'));
        socket.emit('userName', localStorage.getItem('userName')); // добавь соответствующий обработчик на сервере
        socket.emit('userAvatar', localStorage.getItem('userAvatar')); // добавь соответствующий обработчик на сервере
        socket.emit('searchGame');
        socket.on('startGame', ({ roomId, players }) => {
                    // Запуск таймера
            timerInterval = setInterval(updateTimer, 1000);
            cardSelectionScreen.style.display = 'flex'; // Скрываем экран выбора карт
            arena.style.display = 'none'; // Показываем арену
            load.style.display = 'none';
            room_Id = roomId;
            // console.log(`Game started in room ${roomId}`);

            // Сохраняем данные об оппоненте
            const player = players.find(p => p.id === socket.id);
            const opponent = players.find(p => p.id !== socket.id);
            document.getElementById('playerNick').textContent = player.name;
            document.getElementById('opNick').textContent = opponent.name;

            document.querySelector('.avatar.player-avatar').style.backgroundImage = `url(${player.avatar})`;
            document.querySelector('.avatar.player-avatar').style.backgroundSize = 'cover';
            document.querySelector('.avatar.player-avatar').style.backgroundPosition = 'center';

            document.querySelector('.avatar.opponent-avatar').style.backgroundImage = `url(${opponent.avatar})`;
            document.querySelector('.avatar.opponent-avatar').style.backgroundSize = 'cover';
            document.querySelector('.avatar.opponent-avatar').style.backgroundPosition = 'center';


            // Проверяем, что элемент найден
            // if (opponentAvatar && player && player.avatar) {
                // Устанавливаем картинку как фоновое изображение элемента
                // opponentAvatar
                // opponentAvatar.textContent = '';

                // Можно настроить размер фона, чтобы картинка отображалась правильно
                // opponentAvatar.style.backgroundSize = 'cover'; // Заставляем картинку заполнить элемент
                // opponentAvatar.style.backgroundPosition = 'center'; // Центрируем картинку
            // }
            // document.getElementById('opNick').textContent = player.name;
            socket.emit('inArena');
            // if (player) {
            // localStorage.setItem('opName', player.name);
            // localStorage.setItem('opEmail', player.email);
            // localStorage.setItem('opId', player.id);
            // localStorage.setItem('opAva', player.avatar);
            // }
            // console.log(players);
            // Перенаправляем на страницу арены
            // socket.emit('leaveRoom', { roomId });
            // socket.emit('arenaStart', {roomId, players})
            // window.location.href = "arena.html";
        });
        // socket.on('loadingScreen', () => {
        //     // console.log("pidoras x2")

        //     // cardSelectionScreen.style.display = 'none';
        // });

        // socket.emit('inArena');

        if (localStorage.getItem('cardsSelected') === 'true') {
            cardSelectionScreen.style.display = 'none'; // Скрываем экран выбора карт
            arena.style.display = 'block'; // Показываем арену
            load.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const togglePanel = document.getElementById('togglePanel');
            const sidePanel = document.getElementById('sidePanel');
            const arrow = document.querySelector('.toggle-arrow');

            // Открытие и закрытие панели
            togglePanel.addEventListener('click', function () {
                if (sidePanel.style.left === '0px') {
                    sidePanel.style.left = '-250px';
                    arrow.style.transform = 'rotate(0deg)'; // Возвращаем стрелку вправо
                } else {
                    sidePanel.style.left = '0px';
                    arrow.style.transform = 'rotate(180deg)'; // Поворачиваем стрелку влево
                }
            });

            // Закрытие панели при клике вне её области
            document.addEventListener('click', function (event) {
                const isClickInsidePanel = sidePanel.contains(event.target);
                const isClickOnToggle = togglePanel.contains(event.target);

                if (!isClickInsidePanel && !isClickOnToggle) {
                    // Закрываем панель, если клик вне её области и вне кнопки
                    sidePanel.style.left = '-250px';
                    arrow.style.transform = 'rotate(0deg)'; // Возвращаем стрелку вправо
                }
            });

            let hasSelectedCard = false;// Track if the player has selected a card

            fetch('cards.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('JSON данные загружены:', data); // Проверяем, что данные загружены

                    heroCards = data.hero_cards;

                    // Перемешиваем массив героев для случайного выбора
                    const shuffledHeroes = shuffleArray(heroCards).slice(0, 3); // Берем первые 3 карты

                    // Получаем все элементы с классом card-option
                    const cardElements = document.querySelectorAll('.card-option');

                    // Присваиваем каждому div данные о героях без повторений
                    cardElements.forEach((cardElement, index) => {
                        const hero = shuffledHeroes[index];

                        // Назначаем имя героя в data-card атрибут
                        cardElement.setAttribute('data-card', hero.he_name);

                        console.log('data-card установлен на:', cardElement.getAttribute('data-card')); // Проверяем data-card

                        // Изменяем текст внутри div на имя героя
                        cardElement.textContent = hero.he_name;

                        // Присваиваем изображение как фон
                        cardElement.style.backgroundImage = `url(${hero.img})`;
                        cardElement.style.backgroundSize = 'cover'; // Устанавливаем изображение на всю область
                        cardElement.style.backgroundPosition = 'center'; // Центрируем изображение
                    });
                })
                .catch(error => {
                    console.error('Ошибка загрузки JSON:', error); // Отслеживаем ошибки загрузки JSON
                });


            function hideUnselectedCards(selectedOption) {
                console.log('Hiding unselected cards');
                cardOptions.forEach(option => {
                    if (option !== selectedOption) {
                        option.style.visibility = 'hidden'; // Hide other cards
                    }
                });
            }
            // Event listener for each card
            // cardOptions.forEach(option => {
            //     option.addEventListener('click', function () {
            //         if (hasSelectedCard) return; // Prevent re-selection

            //         // Mark the card as selected
            //         hasSelectedCard = true;
            //         hideUnselectedCards(option);

            //         const selectedCard = option.getAttribute('data-card');

            //         // Emit event to server with selected card
            //         console.log(`Emitting cardSelected event with card: ${selectedCard}`);
            //         socket.emit('cardSelected', room_Id, {
            //             playerId: localStorage.getItem('userId'),  // ID игрока из localStorage
            //             card: selectedCard  // Выбранная карта
            //         });

            //         // Highlight the selected card
            //         option.classList.add('selected');
            //     });
            // });

            // Handle the response from the server when both players have selected cards
            socket.on('cardsSelected', (data) => {
                console.log('Received cardsSelected event from server');
                console.log('Players selected cards:', data.players);

                const currentPlayerId = socket.id;

                // Определяем противника и себя
                const opponent = data.players.find(player => player.id !== currentPlayerId);
                const currentPlayer = data.players.find(player => player.id === currentPlayerId);

                // Обработка карты противника
                if (opponent) {
                    console.log(`Opponent's card: ${opponent.card}`);

                    // Находим изображение карты по имени в загруженных данных
                    const opponentHeroCard = heroCards.find(card => card.he_name === opponent.card);

                    if (opponentHeroCard) {
                        const opponentCardImg = opponentHeroCard.img;
                        console.log(`Opponent's card image: ${opponentCardImg}`);

                        // Добавляем стиль для отображения изображения карты противника
                        const opponentCardElement = document.querySelector('.opponentcard-large');
                        if (opponentCardElement) {
                            opponentCardElement.style.backgroundImage = `url(${opponentCardImg})`;
                            opponentCardElement.style.backgroundSize = 'cover';
                            opponentCardElement.style.backgroundPosition = 'center';
                        }
                    } else {
                        console.log('Error: Opponent card not found in heroCards');
                    }
                } else {
                    console.log('Error: Opponent not found in data.players');
                }

                // Обработка карты текущего игрока
                if (currentPlayer) {
                    console.log(`Your card: ${currentPlayer.card}`);

                    // Находим изображение карты по имени в загруженных данных
                    const currentPlayerHeroCard = heroCards.find(card => card.he_name === currentPlayer.card);

                    if (currentPlayerHeroCard) {
                        const currentPlayerCardImg = currentPlayerHeroCard.img;
                        console.log(`Your card image: ${currentPlayerCardImg}`);

                        // Добавляем стиль для отображения изображения карты текущего игрока
                        const currentPlayerCardElement = document.querySelector('.card-large');
                        if (currentPlayerCardElement) {
                            currentPlayerCardElement.style.backgroundImage = `url(${currentPlayerCardImg})`;
                            currentPlayerCardElement.style.backgroundSize = 'cover';
                            currentPlayerCardElement.style.backgroundPosition = 'center';
                        }
                    } else {
                        console.log('Error: Your card not found in heroCards');
                    }
                } else {
                    console.log('Error: Current player not found in data.players');
                }

                // Скрываем экран выбора карт и показываем арену
                cardSelectionScreen.style.display = 'none';
                arena.style.display = 'block';
            });

            socket.on('startRound', (Timer) => {

            });

            socket.on('startTurn', (Timer) => {

            });

            // Debug log to confirm connection
            socket.on('connect', () => {
                console.log('Connected to server with ID:', socket.id);
            });

            // Debug log for errors
            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
            });
        });
    </script>
</body>

</html>