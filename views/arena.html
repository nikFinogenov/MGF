<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Начальный экран выбора карт -->
    <div class="card-selection-screen" id="cardSelectionScreen">
        <div class="screen-header">
            <div class="timer">00:30</div>
            <div class="choose-hero">Choose Your Hero</div>
        </div>
        <div class="card-options">
            <div class="card-option" data-card="card1">Card 1</div>
            <div class="card-option" data-card="card2">Card 2</div>
            <div class="card-option" data-card="card3">Card 3</div>
        </div>
        <button class="random-button">Random</button>
    </div>

    <!-- Фон арены -->
    <img class="arena" src="arena.png" alt="collesium">
    <div id="loading">
        <p>Searching for other player</p>
        <br>
        <div class="loader"></div>
    </div>
    <div class="all">
        <!-- Кнопка для открытия/закрытия панели -->
        <div class="toggle-panel" id="togglePanel">
            <div class="toggle-arrow">></div>
        </div>

        <!-- Выезжающая панель -->
        <div class="side-panel" id="sidePanel">
            <button class="surrender-button">Сдаться</button>
        </div>

        <div class="opponent-avatar-block">
            <div class="avatar opponent-avatar"></div>
            <div class="enemy-nickname" id="opNick">Opponent Nick</div> <!-- Ник противника -->
        </div>

        <!-- Блок для счёта раундов и таймера -->
        <div class="round-timer">
            <!-- Круглый счётчик раундов -->
            <button class="button">Ready</button>
            <div class="round-display">Round: 1</div>

            <!-- Таймер под счётом раундов -->
            <div class="timer-display">00:30</div>
        </div>

        <!-- Блок для аватара и ника игрока -->
        <div class="player-avatar-block">
            <div class="avatar player-avatar"></div>
            <div class="nickname" id="playerNick">Player Nick</div> <!-- Ник игрока -->
        </div>

        <!-- Блок для карты противника сверху -->
        <div class="opponent-card">
            <div class="opponentcard-large">Opponent Card</div>
        </div>

        <!-- Блок для карт сверху -->
        <div class="top-cards">
            <div class="enemycard card-left">Card left</div>
            <div class="enemycard card-center">Card Center</div>
            <div class="enemycard card-right">Card Right</div>
        </div>

        <!-- Блок для карты на поле -->
        <div class="field-card">
            <div class="card-large">Field Card</div>
        </div>

        <!-- Блок для карт снизу -->
        <div class="bottom-cards">
            <div class="card">Card 4</div>
            <div class="card">Card 5</div>
            <div class="card">Card 6</div>
        </div>

        <div class="button-block">
            <button class="button">Action 1</button>
            <button class="button">Action 2</button>
            <div class="gold-display">Gold: 1000</div>
        </div>

        <!-- Вертикальный блок справа -->
        <div class="side-rect">
            <p>Side Block</p>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // window.addEventListener('DOMContentLoaded', () => {

        // });


        const socket = io('http://localhost:3000');
        const arena = document.querySelector('.all');  // Инициализация сокета
        const load = document.querySelector('#loading');  // Инициализация сокета
        const cardOptions = document.querySelectorAll('.card-option');
        const cardSelectionScreen = document.getElementById('cardSelectionScreen');

        let room_Id = null;
        // Отправляем информацию о себе
        socket.emit('userEmail', localStorage.getItem('userEmail'));
        socket.emit('userId', localStorage.getItem('userId'));
        socket.emit('userName', localStorage.getItem('userName')); // добавь соответствующий обработчик на сервере
        socket.emit('userAvatar', localStorage.getItem('userAvatar')); // добавь соответствующий обработчик на сервере
        socket.emit('searchGame');
        socket.on('startGame', ({ roomId, players }) => {
            cardSelectionScreen.style.display = 'flex'; // Скрываем экран выбора карт
            arena.style.display = 'none'; // Показываем арену
            load.style.display = 'none';
            room_Id = roomId;
            // console.log(`Game started in room ${roomId}`);

            // Сохраняем данные об оппоненте
            const player = players.find(p => p.id === socket.id);
            const opponent = players.find(p => p.id !== socket.id);
            document.getElementById('playerNick').textContent = player.name;
            document.getElementById('opNick').textContent = opponent.name;

            document.querySelector('.avatar.player-avatar').style.backgroundImage = `url(${player.avatar})`;
            document.querySelector('.avatar.player-avatar').style.backgroundSize = 'cover';
            document.querySelector('.avatar.player-avatar').style.backgroundPosition = 'center';

            document.querySelector('.avatar.opponent-avatar').style.backgroundImage = `url(${opponent.avatar})`;
            document.querySelector('.avatar.opponent-avatar').style.backgroundSize = 'cover';
            document.querySelector('.avatar.opponent-avatar').style.backgroundPosition = 'center';


            // Проверяем, что элемент найден
            // if (opponentAvatar && player && player.avatar) {
                // Устанавливаем картинку как фоновое изображение элемента
                // opponentAvatar
                // opponentAvatar.textContent = '';

                // Можно настроить размер фона, чтобы картинка отображалась правильно
                opponentAvatar.style.backgroundSize = 'cover'; // Заставляем картинку заполнить элемент
                opponentAvatar.style.backgroundPosition = 'center'; // Центрируем картинку
            // }
            document.getElementById('opNick').textContent = player.name;
            socket.emit('inArena');
            // if (player) {
            // localStorage.setItem('opName', player.name);
            // localStorage.setItem('opEmail', player.email);
            // localStorage.setItem('opId', player.id);
            // localStorage.setItem('opAva', player.avatar);
            // }
            // console.log(players);
            // Перенаправляем на страницу арены
            // socket.emit('leaveRoom', { roomId });
            // socket.emit('arenaStart', {roomId, players})
            // window.location.href = "arena.html";
        });
        // socket.on('loadingScreen', () => {
        //     // console.log("pidoras x2")

        //     // cardSelectionScreen.style.display = 'none';
        // });

        // socket.emit('inArena');

        if (localStorage.getItem('cardsSelected') === 'true') {
            cardSelectionScreen.style.display = 'none'; // Скрываем экран выбора карт
            arena.style.display = 'block'; // Показываем арену
            load.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const togglePanel = document.getElementById('togglePanel');
            const sidePanel = document.getElementById('sidePanel');
            const arrow = document.querySelector('.toggle-arrow');

            // Открытие и закрытие панели
            togglePanel.addEventListener('click', function () {
                if (sidePanel.style.left === '0px') {
                    sidePanel.style.left = '-250px';
                    arrow.style.transform = 'rotate(0deg)'; // Возвращаем стрелку вправо
                } else {
                    sidePanel.style.left = '0px';
                    arrow.style.transform = 'rotate(180deg)'; // Поворачиваем стрелку влево
                }
            });

            // Закрытие панели при клике вне её области
            document.addEventListener('click', function (event) {
                const isClickInsidePanel = sidePanel.contains(event.target);
                const isClickOnToggle = togglePanel.contains(event.target);

                if (!isClickInsidePanel && !isClickOnToggle) {
                    // Закрываем панель, если клик вне её области и вне кнопки
                    sidePanel.style.left = '-250px';
                    arrow.style.transform = 'rotate(0deg)'; // Возвращаем стрелку вправо
                }
            });

            let hasSelectedCard = false; // Track if the player has selected a card

            function hideUnselectedCards(selectedOption) {
                console.log('Hiding unselected cards');
                cardOptions.forEach(option => {
                    if (option !== selectedOption) {
                        option.style.visibility = 'hidden'; // Hide other cards
                    }
                });
            }

            // Event listener for each card
            cardOptions.forEach(option => {
                option.addEventListener('click', function () {
                    if (hasSelectedCard) return; // Prevent re-selection

                    // Mark the card as selected
                    hasSelectedCard = true;
                    hideUnselectedCards(option);

                    const selectedCard = option.getAttribute('data-card');

                    // Emit event to server with selected card
                    console.log(`Emitting cardSelected event with card: ${selectedCard}`);
                    socket.emit('cardSelected', room_Id, {
                        playerId: localStorage.getItem('userId'),  // ID игрока из localStorage
                        card: selectedCard  // Выбранная карта
                    });

                    // Highlight the selected card
                    option.classList.add('selected');
                });
            });

            // Handle the response from the server when both players have selected cards
            socket.on('cardsSelected', (data) => {
                console.log('Received cardsSelected event from server');
                console.log('Players selected cards:', data.players);

                // Hide card selection screen, show arena
                cardSelectionScreen.style.display = 'none';
                arena.style.display = 'block';
            });

            socket.on('startRound', (Timer) => {

            });

            socket.on('startTurn', (Timer) => {

            });

            // Debug log to confirm connection
            socket.on('connect', () => {
                console.log('Connected to server with ID:', socket.id);
            });

            // Debug log for errors
            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
            });
        });
    </script>
</body>

</html>